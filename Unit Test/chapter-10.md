# 10장. 데이터베이스 테스트

## 데이터베이스 테스트를 위한 전제조건

1. 데이터베이스 스키마는 일반 코드로 취급해야 함
   - 모델 데이터베이스를 기준점으로 두고 이를 운영 데이터베이스와 비교하여 업데이트하는 것은 좋지 못한 방식
     - 변경 내역 부재 : 데이터베이스 스키마를 특정 시점으로 되돌릴 수 없음
     - 복수의 원천 정보 : 개발 상태에 대한 원천 정보를 둘러싸고 경합하게 됨
2. 참조 데이터베이스도 데이터베이스 스키마다.
   - 데이터베이스 스키마에 속하지만 데이터베이스 스키마로 거의 여기지 않음
   - 참조 데이터란 애플리케이션이 제대로 작동하도록 `미리 채워야 하는 데이터`
     - UserType, 통화 종류, 국가 코드 테이블 등
3. 모든 개발자를 위한 별도의 데이터베이스 인스턴스를 사용할 필요가 있음
4. 상태 기반 데이터베이스 배포 / 마이그레이션 기반 데이터베이스 배포
   - 상태 기반 방식
     - 개발 내내 유지 보수하는 모델 데이터베이스 존재
     - 비교 도구를 통해 운영 데이터베이스를 모델 데이터베이스와 비교하여 최신 상태 유지
     - 다만 물리적인 모델 데이터베이스가 원천 데이터가 아니라 SQL 스크립트가 존재하여 이 스크립트를 형상관리에 저장
   - 마이그레이션 기반 방식
     - 데이터베이스를 어떤 버전에서 다른 버전으로 전환하는 명시적 마이그레이션을 의미
     - 운영 데이터베이스와 개발 데이터베이스를 자동으로 동기화하기 위한 도구를 쓸 수 없고, 업그레이드 스크립트를 직접 작성해야 함
   - **상태 기반 방식보다 마이그레이션 방식을 선호하라**
     - 상태 기반 방식 : 상태가 명시적이고, 마이그레이션 메커니즘이 암묵적
     - 마이그레이션 기반 방식 : 상태는 암묵적이고, 마이그레이션 메커니즘이 명시적
     - 데이터베이스 상태가 명확하면 병합 충돌하기가 수월한 반면, 명시적 마이그레이션은 데이터 모션 문제를 해결하는 데 도움이 됨
       - 데이터 모션 : 새로운 데이터베이스 스키마를 준수하도록 기존 데이터의 형태를 변경하는 과정
     - 일반적으로 데이터 모션이 병합 충돌보다 훨씬 까다로운 문제이기에, 더 중요함.
  
## 데이터베이스 트랜잭션 관리

데이터베이스 트랜잭션 관리는 제품 코드와 테스트 코드 모두에 중요한 주제로, 제품 코드에서 트랜잭션 관리를 적절히 하면 데이터 모순을 피할 수 있음

- 메서드마다 트랜잭션을 열게 되면, 원자성이 깨지게 됨
- 읽기 전용 연산 중에서는 여러 트랜잭션을 열어도 괜찮지만, 데이터 변경이 포함된다면 모든 업데이트는 원자적이어야 함
  - 원자적 업데이트는 모두 수행하거나 전혀 수행하지 않는 것
- 잠재적인 모순을 피하기 위해서는 결정 유형을 두 가지로 나누어야 함
  - 업데이트할 데이터 (리포지토리)
  - 업데이트 유지 또는 롤백 여부 (트랜잭션)
- 리포지토리는 언제나 트랜잭션 위에서 동작함 (수명이 짧음)