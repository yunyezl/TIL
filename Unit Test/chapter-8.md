# 8장. 통합 테스트를 하는 이유

## 통합 테스트란?

- 단위 테스트는 다음 세 가지 요구 사항을 충족
  - 단일 동작 단위를 검증
  - 빠르게 수행
  - 다른 테스트와 별도 처리
- 위 세 가지 조건 중, 하나라도 충족하지 못하는 테스트는 통합 테스트 범주에 속함
- 단위 테스트로 가능한 한 많이 비즈니스 시나리오의 예외 상황을 확인하고, 통합 테스트는 주요 흐름과 단위 테스트가 다루지 못하는 기타 예외 상황을 다룸
  - 단위 테스트가 다루지 못하는 기타 예외 상황: 목으로 대체할 수 없는 프로세스 외부 의존성 (대개 데이터베이스)
- 시스템이 프로세스 외부 의존성과 어떻게 통합하는지를 검증

## 통합 테스트와 빠른 실패

- 비즈니스 시나리오 당 하나의 주요 흐름과 단위 테스트로 처리할 수 없는 모든 예외 상황을 다루는 지침에 대한 설명
- 통합 테스트에서 프로세스 외부 의존성과의 상호 작용을 모두 확인하기 위해서는 가장 긴 주요 흐름을 선택해야 함
  - 모든 상호 작용을 거치는 흐름이 없으면, 외부 시스템과의 통신을 모두 확인하는 데 필요한 만큼 통합 테스트를 추가로 작성해야 함

## 프로세스 외부 의존성의 두 가지 유형

- 어떤 프로세스 외부 의존성을 직접 테스트해야 하는가?
- 프로세스 외부 의존성의 두 가지 유형
  1. **관리 의존성**(전체를 제어할 수 있는 프로세스 외부 의존성): 애플리케이션을 통해서만 접근할 수 있으며 외부 환경에서 볼 수 없는 의존성. (DB)
  2. **비관리 의존성**(전체를 제어할 수 없는 프로세스 외부 의존성): 해당 의존성과의 상호 작용을 외부에서 볼 수 있음. (SMTP 서버, 메시지 버스)
- 관리 의존성은 구현 세부 사항이지만, 비관리 의존성과의 통신은 시스템의 식별할 수 있는 동작으로 통합 테스트에서의 프로세스 외부 의존성 처리가 달라짐.
- 관리 의존성이면서 비관리 의존성인 프로세스 외부 의존성 다루기
  - 전용 데이터 베이스로 시작했지만 다른 시스템의 요구 사항으로 인해 일부 테이블만 접근 권한을 공유하는 상황
  - 시스템 간의 통합을 구현하는 데 있어서 데이터베이스를 사용하는 것은 좋지 않으므로, API 혹은 메시지 버스를 사용하는 것이 더 좋음
  - 그러나 그렇지 않은 상황에서는, 해당 데이터베이스를 비관리 의존성으로 취급함

## 의존성 추상화를 위한 인터페이스 사용

- **인터페이스와 느슨한 결합**
  - 인터페이스를 사용하는 이유로, 일반적으로 다음과 같은 이유가 있음
    - 느슨한 결합 달성 : 단일 구현을 위한 인터페이스는 추상화로 보기 어려우며 구체 클래스보다 결합도가 낮다고 볼 수 없음
    - 공개 폐쇄 원칙 : 기존 코드를 변경하지 않고 새로운 기능을 추가해 공개 폐쇄 원칙을 지킬 수 있다고 생각할 수 있지만, 이는 `YAGNI(Yon aren't gonna need it)` 원칙을 위반하기에 잘못된 생각임
  - 그렇다면 어떤 이유로?
    - 테스트 대역을 만들기 위함이 가장 큼. 따라서 의존성을 목으로 처리할 필요가 없는 한, 프로세스 외부 의존성에 대해 인터페이스를 두지 말 것.

## 통합 테스트 모범 사례

- 통합 테스트를 최대한 활용하는 데 도움이 되는 지침
  - 도메인 모델 경계 명시하기
    - 도메인 모델을 코드베이스에서 명시적이고 잘 알려진 위치에 둘 것
  - 애플리케이션 내 계층 줄이기
    - 애플리케이션에서 추상 계층이 너무 많으면 코드베이스를 탐색하기 어렵고 숨은 로직을 이해하기가 어려워진다.
  - 순환 의존성 제거하기
    - 해결책을 찾기 위한 출발점이 명확하지 않아진다.
- 테스트에서 다중 실행 구절 사용
  - 테스트에서 두 개 이상의 준비나 실행 또는 검증 구절을 두는 것은 '코드 악취'에 해당
  - 예외로, 원하는 상태로 만들기 어려운 프로세스 외부 의존성으로 작동하는 테스트가 있을 수 있음. 이 경우에는 여러 동작을 하나의 테스트로 묶어서 문제가 있는 프로세스 외부 의존성에 대한 상호 작용 횟수를 줄이는 것이 유리함.

## 로깅

- 진단 로깅과 지원 로깅을 구분
  - 진단 로깅의 경우, 구체적인 세부 사항이므로 테스트할 필요 없음
  - 지원 로깅의 경우 테스트할 필요가 있음
    - 라이브러리로 작성하는 경우, 식별할 수 있는 동작에서 가장 중요한 부분이 됨
    - 또 다른 예로, 비즈니스 담당자가 작업 흐름을 기록해야한다고 주장할 경우 이 경우 로그는 비즈니스 요구 사항이 되기에 테스트 해야 함.
- 진단 로깅은 얼마나 많은 것이 충분한건지?
  - 도메인 모델에서는 진단 로깅을 절대로 사용하지 말 것.
- 로거 인스턴스의 전달
  - 정적 메서드를 통해 로거를 처리하고 비공개 정적 필드에 저장하는 전략은 안티 패턴임
    - 의존성이 숨어있고 변경하기 어려움
    - 테스트가 어려워짐
    - ambient context에 의존하는 것은, 문제의 징후로 볼 수 있음
      - 로그를 너무 많이 남겼거나, 너무 많은 간접 계층을 사용한 것이 아닌지 의심할 필요